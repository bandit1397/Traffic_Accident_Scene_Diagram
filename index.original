<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Traffic Accident Scene Diagram</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; background:#eee; font-family:sans-serif; }

#container {
  position: relative;
  width:210mm;
  min-height:297mm;
  margin:20px auto;
  padding:10mm;
  background:#fff;
  border:1px solid #ccc;
}

h1 { text-align:center; }

#map {
  width:100%;
  height:600px;
  border:1px solid #888;
  position:relative;
}

/* ===== ì»¨íŠ¸ë¡¤ ===== */
#controls {
  display:flex;
  justify-content:center;
  gap:6px;
  margin-top:8px;
  overflow-x:auto;
  padding:2px 0;
}

#controls::-webkit-scrollbar { height:4px; }
#controls::-webkit-scrollbar-thumb {
  background:#888;
  border-radius:2px;
}

button { padding:5px 10px; }

/* ===== ê°ì²´ ===== */
.icon, .arrow {
  position:absolute;
  cursor:move;
  z-index:1000;
}

.arrow { transform-origin:center; }

.textbox {
  position:absolute;
  border:1px solid #333;
  background:#fff;
  padding:2px;
  resize:both;
  cursor:move;
  z-index:1000;
}

/* ===== ì†ì„± íŒ¨ë„ ===== */
/* ===== ì†ì„± íŒ¨ë„ (ì§€ë„ ë‚´ë¶€ ê¸°ì¤€) ===== */
#panel {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);

  background: #fff;
  border: 1px solid #333;
  padding: 10px;
  width: 200px;

  display: block;
  visibility: hidden;
  opacity: 0;

  z-index: 3000;
}



#panel label {
  font-size:12px;
  display:block;
  margin-top:6px;
}

/* ===== ëª¨ë°”ì¼ ===== */
@media (max-width: 768px){
  #controls {
    flex-wrap: wrap;
    gap: 4px;
  }

  #controls button {
    flex: 1 1 30%;
    min-width: 80px;
    min-height: 40px;
    font-size: 14px;
  }

  /* âœ… ì†ì„± íŒ¨ë„ ëª¨ë°”ì¼ ìŠ¬ë¦¼í™” */
  #panel {
    position: absolute;        /* ê¸°ì¡´ ìœ ì§€ */
    right: auto;
    bottom: auto;

    width: 105px;              /* â­ íŒ¨ë„ í­ ì¡°ì ˆ */
    padding: 6px;              /* â­ ë‚´ë¶€ ì—¬ë°± ì¶•ì†Œ */

    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,.25);
  }

  #panel label {
    font-size: 12px;           /* â­ ê¸€ì ì‘ê²Œ */
  }

  #panel input {
    width: 42px;               /* â­ í•µì‹¬: íŒ¨ë„ ì•ˆì—ì„œ ì•ˆ ë°€ë¦¬ê²Œ */
    font-size: 12px;
  }
}

</style>
</head>

<body>

<div id="container">
  <h1>êµí†µì‚¬ê³  í˜„ì¥ì•½ë„</h1>

  <div id="map">
    <!-- Leaflet map ë˜ëŠ” ë°°ê²½ ì§€ë„ -->

    <!-- ì†ì„± íŒ¨ë„ (ì§€ë„ ë‚´ë¶€ í¬í•¨) -->
    <div id="panel">
      <strong>ì„ íƒ ê°ì²´</strong>
      <label>ê°ë„ <input id="angle" type="number"></label>
      <label>í¬ê¸° <input id="size" type="number"></label>
      <label>ê¸€ìí¬ê¸° <input id="fontSize" type="number"></label>
      <label>í­ <input id="width" type="number"></label>
    </div>

  </div>

  <div id="controls">
    <button onclick="addIcon('person')">ì‚¬ëŒ</button>
    <button onclick="addIcon('car')">ìë™ì°¨</button>
    <button onclick="addIcon('bike')">ìì „ê±°</button>
    <button onclick="addIcon('moto')">ì˜¤í† ë°”ì´</button>
    <button onclick="addArrow()">í™”ì‚´í‘œ</button>
    <button onclick="addText()">ë¬¸ì</button>
    <button onclick="toggleMap()">ì§€ë„ ì ê¸ˆ / í•´ì œ</button>
    <button onclick="savePDF()">PDF</button>
  </div>
</div>


<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ===== ì§€ë„ ===== */
const leafletMap = L.map('map',{
  maxZoom:19,
  zoomSnap:0.25,
  wheelPxPerZoomLevel:40
}).setView([37.5665,126.978],18);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'Â© OpenStreetMap'
}).addTo(leafletMap);

/* ===== ì§€ë„ ì ê¸ˆ ===== */
let mapLocked=false;
function lockMap(){
  leafletMap.dragging.disable();
  leafletMap.touchZoom.disable();
  leafletMap.doubleClickZoom.disable();
  leafletMap.scrollWheelZoom.disable();
  leafletMap.boxZoom.disable();
  leafletMap.keyboard.disable();
  if(leafletMap.tap) leafletMap.tap.disable();
  mapLocked=true;
}
function unlockMap(){
  leafletMap.dragging.enable();
  leafletMap.touchZoom.enable();
  leafletMap.doubleClickZoom.enable();
  leafletMap.scrollWheelZoom.enable();
  leafletMap.boxZoom.enable();
  leafletMap.keyboard.enable();
  if(leafletMap.tap) leafletMap.tap.enable();
  mapLocked=false;
}
function toggleMap(){ mapLocked ? unlockMap() : lockMap(); }

/* ===== ê³µí†µ ===== */
const icons={
  person:'icons/person.png',
  car:'icons/car.png',
  bike:'icons/bike.png',
  moto:'icons/moto.png',
  arrow:'icons/arrow.png'
};

const mapDiv=leafletMap.getContainer();
const panel=document.getElementById('panel');
let selected=null;
let panelInitialized = false;

function centerPos(){
  const r=mapDiv.getBoundingClientRect();
  return {x:r.width/2-16,y:r.height/2-16};
}

function select(el){
  if (selected === el) return;

  selected = el;

  // ğŸ”‘ íŒ¨ë„ ë³´ì´ê²Œ (í•­ìƒ)
  panel.style.display = 'block';    
  panel.style.visibility = 'visible';
  panel.style.opacity = '1';

  // ğŸ”‘ ì´ë¯¸ íŒ¨ë„ì´ í•œ ë²ˆ ìœ„ì¹˜ ì¡í˜”ìœ¼ë©´ ë‹¤ì‹œ ê³„ì‚° âŒ
  if (panelInitialized) return;

  panelInitialized = true;

  if (window.innerWidth <= 768) {
    const mapRect = mapDiv.getBoundingClientRect();
    const elRect  = el.getBoundingClientRect();
    const pw = panel.offsetWidth;
    const ph = panel.offsetHeight;
    const m  = 8;

    let left = elRect.right - mapRect.left + m;
    let top  = elRect.top   - mapRect.top;

    if (left + pw > mapRect.width) {
      left = elRect.left - mapRect.left - pw - m;
    }

    if (top < 0) top = 0;
    if (top + ph > mapRect.height) {
      top = mapRect.height - ph;
    }

    panel.style.left   = left + 'px';
    panel.style.top    = top  + 'px';
    panel.style.right  = 'auto';
    panel.style.bottom = 'auto';
    
  } else {
    panel.style.position = 'absolute';
    panel.style.left = '10px';
    panel.style.top = '50%';
    panel.style.transform = 'translateY(-50%)';
  }

}

function drag(el){
  let sx,sy,ox,oy,dragging=false;
  el.style.touchAction='none';

  el.addEventListener('pointerdown', e => {
    select(el);

    const isInput = el.tagName === 'INPUT';

    sx = e.clientX;
    sy = e.clientY;
    ox = parseFloat(el.style.left);
    oy = parseFloat(el.style.top);
    dragging = true;

    el.setPointerCapture(e.pointerId);

    if (!isInput) e.preventDefault();
  });


  el.addEventListener('pointermove',e=>{
    if(!dragging) return;
    el.style.left=(ox+e.clientX-sx)+'px';
    el.style.top =(oy+e.clientY-sy)+'px';
  });

  el.addEventListener('pointerup',()=>dragging=false);
}

function enableDelete(el){
  el.addEventListener('contextmenu',e=>{
    e.preventDefault();
    if(confirm('ì´ ê°ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) el.remove();
  });
}

/* ===== ê°ì²´ ì¶”ê°€ ===== */
function addIcon(type){
  const p=centerPos();
  const img=document.createElement('img');
  img.src=icons[type];
  img.className='icon';
  img.style.left=p.x+'px';
  img.style.top =p.y+'px';
  img.style.width='32px';
  mapDiv.appendChild(img);
  drag(img); enableDelete(img);
}

function addArrow(){
  const p=centerPos();
  const a=document.createElement('img');
  a.src=icons.arrow;
  a.className='arrow';
  a.style.left=p.x+'px';
  a.style.top =p.y+'px';
  a.style.width='32px';
  mapDiv.appendChild(a);
  drag(a); enableDelete(a);
}

function addText(){
  const p = centerPos();
  const t = document.createElement('input');
  t.className = 'textbox';
  t.placeholder = 'í…ìŠ¤íŠ¸';
  t.style.left = p.x + 'px';
  t.style.top  = p.y + 'px';
  t.style.fontSize = '14px';
  t.style.height = 'auto';
  t.style.minHeight = '20px';
  t.style.padding = '0 4px';
  t.style.textAlign = 'center';
  t.style.width = '14px'; // ì´ˆê¸° í­
  mapDiv.appendChild(t);

  drag(t);
  enableDelete(t);

  // -----------------------------
  // í­ ê³„ì‚° í•¨ìˆ˜
  // -----------------------------
  const adjustSize = () => {
    const fs = parseFloat(window.getComputedStyle(t).fontSize) || 14;
    const text = t.value || t.placeholder || 'í•œ';
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.font = `${fs}px sans-serif`;
    const textWidth = ctx.measureText(text).width;
    t.style.width = (textWidth + 8) + 'px'; // ì¢Œìš° 4px ì—¬ë°± í¬í•¨
    t.style.height = (fs + 4) + 'px'; // ë†’ì´: ê¸€ì í¬ê¸° + 4px
  };

  // -----------------------------
  // ì´ë²¤íŠ¸
  // -----------------------------
  t.addEventListener('input', adjustSize);
  t.addEventListener('change', adjustSize);

  // fontSize íŒ¨ë„ ì…ë ¥ì—ì„œ ì¦‰ì‹œ ì ìš©
  const fontInput = document.getElementById('fontSize');
  fontInput.addEventListener('input', () => {
    if(selected === t){
      t.style.fontSize = fontInput.value + 'px';
      adjustSize(); // ë°”ë¡œ í­ ì¡°ì ˆ
    }
  });

  // í´ë¦­/í„°ì¹˜ ì‹œì—ë„ í­ ì¬ì¡°ì •
  t.addEventListener('pointerdown', adjustSize);

  adjustSize(); // ì´ˆê¸° ì ìš©
}

/* ===== íŒ¨ë„ ì…ë ¥ ===== */
angle.oninput=e=>{
  if(selected) selected.style.transform=`rotate(${e.target.value}deg)`;
};
size.oninput=e=>{
  if(selected&&selected.tagName==='IMG')
    selected.style.width=e.target.value+'px';
};
fontSize.oninput=e=>{
  if(selected&&selected.tagName==='INPUT')
    selected.style.fontSize=e.target.value+'px';
};
width.oninput=e=>{
  if(selected&&selected.tagName==='INPUT')
    selected.style.width=e.target.value+'px';
};

/* ===== PDF ===== */
async function savePDF(){
  lockMap();
  const canvas=await html2canvas(container,{useCORS:true});
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF('p','mm','a4');
  const w=pdf.internal.pageSize.getWidth();
  const h=canvas.height*w/canvas.width;
  pdf.addImage(canvas.toDataURL(),'PNG',0,0,w,h);
  pdf.save('Traffic_Accident_Scene_Diagram.pdf');
  unlockMap();
}
(function(){
  const panel = document.getElementById('panel');
  const mapDiv = document.getElementById('map');

  let sx=0, sy=0, ox=0, oy=0, dragging=false;

  panel.style.touchAction = 'none';

  panel.addEventListener('pointerdown', e => {
    if (e.target.tagName === 'INPUT') return;

    dragging = true;
    sx = e.clientX;
    sy = e.clientY;

    const mapRect   = mapDiv.getBoundingClientRect();
    const panelRect = panel.getBoundingClientRect();

    /* âœ… í•µì‹¬ â‘  transform ì œê±° */
    panel.style.transform = 'none';

    /* âœ… í•µì‹¬ â‘¡ í˜„ì¬ ë³´ì´ëŠ” ìœ„ì¹˜ë¥¼ left/topìœ¼ë¡œ ê³ ì • */
    panel.style.left = (panelRect.left - mapRect.left) + 'px';
    panel.style.top  = (panelRect.top  - mapRect.top)  + 'px';

    ox = parseFloat(panel.style.left);
    oy = parseFloat(panel.style.top);

    panel.setPointerCapture(e.pointerId);
    e.preventDefault();
  });

  panel.addEventListener('pointermove', e => {
    if (!dragging) return;

    panel.style.left = (ox + e.clientX - sx) + 'px';
    panel.style.top  = (oy + e.clientY - sy) + 'px';
  });

  panel.addEventListener('pointerup', ()=>dragging=false);
  panel.addEventListener('pointercancel', ()=>dragging=false);
})();

</script>
</body>
</html>
