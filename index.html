<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>êµí†µì‚¬ê³  í˜„ì¥ì•½ë„ (í¸ì§‘ê¸° ìµœì¢…)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; background:#eee; font-family:sans-serif; }

#container {
  width:210mm; min-height:297mm;
  margin:20px auto; padding:10mm;
  background:#fff; border:1px solid #ccc;
}

h1 { text-align:center; }

#map {
  width:100%;
  height:600px;
  border:1px solid #888;
  position:relative;
}

#controls {
  display:flex;
  justify-content:center;
  gap:6px;
  margin-top:8px;
}

button { padding:5px 10px; }

.icon, .arrow {
  position:absolute;
  cursor:move;
  z-index:1000;
}

.arrow { transform-origin:center; }

.textbox {
  position:absolute;
  border:1px solid #333;
  background:#fff;
  padding:2px;
  resize:both;
  overflow:auto;
  cursor:move;
  z-index:1000;
}

/* ì†ì„± íŒ¨ë„ */
#panel {
  position:fixed;
  right:10px;
  bottom:10px;
  background:#fff;
  border:1px solid #333;
  padding:10px;
  width:200px;
  display:none;
  z-index:2000;
}

#panel label {
  font-size:12px;
  display:block;
  margin-top:6px;
}
</style>
</head>

<body>

<div id="container">
<h1>êµí†µì‚¬ê³  í˜„ì¥ì•½ë„</h1>

<div id="map"></div>

<div id="controls">
<button onclick="addIcon('person')">ì‚¬ëŒ</button>
<button onclick="addIcon('car')">ìë™ì°¨</button>
<button onclick="addIcon('bike')">ìì „ê±°</button>
<button onclick="addIcon('moto')">ì˜¤í† ë°”ì´</button>
<button onclick="addArrow()">í™”ì‚´í‘œ</button>
<button onclick="addText()">ë¬¸ì</button>
<button onclick="toggleMap()">ì§€ë„ ì ê¸ˆ / í•´ì œ</button>
<button onclick="savePDF()">PDF</button>
</div>
</div>

<!-- ì†ì„± íŒ¨ë„ -->
<div id="panel">
<strong>ì„ íƒ ê°ì²´</strong>
<label>ê°ë„ <input id="angle" type="number"></label>
<label>í¬ê¸° <input id="size" type="number"></label>
<label>ê¸€ìí¬ê¸° <input id="fontSize" type="number"></label>
<label>í­ <input id="width" type="number"></label>
</div>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* =========================
   ì§€ë„ ìƒì„±
   ========================= */
const leafletMap = L.map('map', {
  maxZoom: 19,          // âœ… ì§€ë„ ìì²´ëŠ” 19ê¹Œì§€ë§Œ
  zoomSnap: 0.25,
  wheelPxPerZoomLevel: 40
}).setView([37.5665, 126.978], 18);

/* =========================
   ì§€ë„ ì ê¸ˆ / í•´ì œ (ğŸ“Œ ì—¬ê¸°!)
   ========================= */
let mapLocked = false;

function lockMap(){
  leafletMap.dragging.disable();
  leafletMap.scrollWheelZoom.disable();
  leafletMap.doubleClickZoom.disable();
  leafletMap.boxZoom.disable();
  leafletMap.keyboard.disable();
  if (leafletMap.tap) leafletMap.tap.disable();
  mapLocked = true;
}

function unlockMap(){
  leafletMap.dragging.enable();
  leafletMap.scrollWheelZoom.enable();
  leafletMap.doubleClickZoom.enable();
  leafletMap.boxZoom.enable();
  leafletMap.keyboard.enable();
  if (leafletMap.tap) leafletMap.tap.enable();
  mapLocked = false;
}

function toggleMap(){
  if(mapLocked){
    unlockMap();
    alert('ì§€ë„ ì´ë™ ê°€ëŠ¥');
  } else {
    lockMap();
    alert('ì§€ë„ ê³ ì •ë¨');
  }
}

/* =========================
   íƒ€ì¼ ë ˆì´ì–´
   ========================= */
L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  {
    maxZoom: 19,
    attribution: 'Â© OpenStreetMap'
  }
).addTo(leafletMap);



/* ê¸°ì¡´ ì½”ë“œ í˜¸í™˜ìš© map ê°ì²´ */
const map = {
  getDiv: () => leafletMap.getContainer()
};

setTimeout(() => {
  leafletMap.invalidateSize();
}, 300);

/* =========================
   ì•„ì´ì½˜ ì •ì˜
   ========================= */
const icons = {
  person:'icons/person.png',
  car:'icons/car.png',
  bike:'icons/bike.png',
  moto:'icons/moto.png',
  arrow:'icons/arrow.png'
};

let selected = null;
const panel = document.getElementById('panel');

/* =========================
   ê³µí†µ í•¨ìˆ˜
   ========================= */
function centerPos(){
  const r = map.getDiv().getBoundingClientRect();
  return { x:r.width/2-16, y:r.height/2-16 };
}

function select(el){
  selected = el;
  panel.style.display = 'block';
  updatePanel();
}

function updatePanel(){
  if(!selected) return;
  angle.value = getRotation(selected) || 0;
  size.value = selected.offsetWidth || '';
  fontSize.value = parseInt(selected.style.fontSize) || '';
  width.value = parseInt(selected.style.width) || '';
}

angle.oninput = () => {
  selected.style.transform = `rotate(${angle.value}deg)`;
};

size.oninput = () => {
  selected.style.width = selected.style.height = size.value + 'px';
};

fontSize.oninput = () => {
  selected.style.fontSize = fontSize.value + 'px';
};

width.oninput = () => {
  selected.style.width = width.value + 'px';
};

function drag(el){
  let dragging = false, ox = 0, oy = 0;

  el.onmousedown = e => {
    if(e.shiftKey) return;
    dragging = true;
    ox = e.offsetX;
    oy = e.offsetY;
    select(el);
  };

  document.onmousemove = e => {
    if(!dragging) return;
    const r = map.getDiv().getBoundingClientRect();
    el.style.left = (e.clientX - r.left - ox) + 'px';
    el.style.top  = (e.clientY - r.top  - oy) + 'px';
  };

  document.onmouseup = () => dragging = false;
}

/* =========================
   ê°ì²´ ì¶”ê°€
   ========================= */
function addIcon(type){
  const p = centerPos();
  const img = document.createElement('img');
  img.src = icons[type];
  img.className = 'icon';
  img.style.left = p.x + 'px';
  img.style.top  = p.y + 'px';
  img.style.width = '32px';
  map.getDiv().appendChild(img);
  drag(img);
  img.ondblclick = () => img.remove();
}

function addArrow(){
  const p = centerPos();
  const a = document.createElement('img');
  a.src = icons.arrow;
  a.className = 'arrow';
  a.style.left = p.x + 'px';
  a.style.top  = p.y + 'px';
  a.style.width = '32px';
  map.getDiv().appendChild(a);
  drag(a);

  a.onwheel = e => {
    e.preventDefault();
    let r = getRotation(a) + (e.deltaY > 0 ? 15 : -15);
    a.style.transform = `rotate(${r}deg)`;
    updatePanel();
  };

  a.ondblclick = () => a.remove();
}

function addText(){
  const p = centerPos();
  const t = document.createElement('input');
  t.className = 'textbox';
  t.style.left = p.x + 'px';
  t.style.top  = p.y + 'px';
  t.placeholder = 'í…ìŠ¤íŠ¸';
  map.getDiv().appendChild(t);
  drag(t);
  t.ondblclick = () => t.remove();
}

function getRotation(el){
  const tr = getComputedStyle(el).transform;
  if(tr === 'none') return 0;
  const v = tr.split('(')[1].split(')')[0].split(',');
  return Math.round(Math.atan2(v[1], v[0]) * 180 / Math.PI);
}

/* =========================
   ì§€ë„ ì´ë¯¸ì§€ ê³ ì • (PDFìš©)
   ========================= */
async function freezeMapAsImage() {
  const mapDiv = leafletMap.getContainer();

  const canvas = await html2canvas(mapDiv, {
    useCORS: true,
    allowTaint: true,
    backgroundColor: null
  });

  const img = document.createElement('img');
  img.src = canvas.toDataURL('image/png');
  img.style.width = '100%';
  img.style.height = '100%';
  img.style.position = 'absolute';
  img.style.top = '0';
  img.style.left = '0';
  img.style.zIndex = 1;

  mapDiv.innerHTML = '';
  mapDiv.appendChild(img);
}

/* =========================
   PDF ì €ì¥
   ========================= */
async function savePDF(){
  lockMap();                 // 1ï¸âƒ£ ì§€ë„ ì´ë™ ì ê¸ˆ
  await freezeMapAsImage();  // 2ï¸âƒ£ ì§€ë„ â†’ ì´ë¯¸ì§€ ê³ ì •

  html2canvas(container, { useCORS:true }).then(canvas => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('p','mm','a4');
    const w = pdf.internal.pageSize.getWidth();
    const h = canvas.height * w / canvas.width;
    pdf.addImage(canvas.toDataURL('image/png'),'PNG',0,0,w,h);
    pdf.save('êµí†µì‚¬ê³ _í˜„ì¥ì•½ë„.pdf');
  });
}

</script>

</body>
</html>
