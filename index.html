<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Traffic Accident Scene Diagram</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body { margin:0; background:#eee; font-family:sans-serif; }

#container {
  position: relative;
  width:210mm;
  min-height:297mm;
  margin:20px auto;
  padding:10mm;
  background:#fff;
  border:1px solid #ccc;
}

h1 { text-align:center; }

#map {
  width:100%;
  height:600px;
  border:1px solid #888;
  position:relative;
  overflow:hidden;
}

/* ===== 카카오 지도 이미지 ===== */
#bgMap {
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  object-fit:contain;
  user-select:none;
  pointer-events:none;
  z-index:1;
}

/* ===== 자유곡선 캔버스 ===== */
#drawCanvas {
  position:absolute;
  inset:0;
  z-index:500;
}

/* ===== 객체 ===== */
.icon, .arrow {
  position:absolute;
  cursor:move;
  z-index:1000;
}
.arrow { transform-origin:center; }

.textbox {
  position:absolute;
  border:1px solid #333;
  background:#fff;
  padding:2px;
  resize:both;
  cursor:move;
  z-index:1000;
}

/* ===== 속성 패널 ===== */
#panel {
  position:absolute;
  left:10px;
  top:50%;
  transform:translateY(-50%);
  background:#fff;
  border:1px solid #333;
  padding:10px;
  width:200px;
  visibility:hidden;
  opacity:0;
  z-index:3000;
}

#panel label {
  font-size:12px;
  display:block;
  margin-top:6px;
}

#panel input[type="range"]{
  width:100%;
}

/* ===== 도구 패널 ===== */
#toolbox {
  position:absolute;
  top:10px;
  left:10px;
  z-index:4000;
}

#toolToggle {
  width:44px;
  height:44px;
  font-size:22px;
  border-radius:8px;
  background:#333;
  color:#fff;
  border:none;
}

#toolContent {
  display:none;
  margin-top:6px;
  background:#fff;
  border:1px solid #333;
  border-radius:10px;
  padding:6px;
  width:120px;
}

#toolContent button {
  width:100%;
  min-height:32px;
  margin:2px 0;
  font-size:13px;
}

#toolContent label {
  font-size:12px;
  display:block;
  margin-top:4px;
}

#toolContent hr {
  margin:6px 0;
}
</style>
</head>

<body>

<div id="container">
  <h1>교통사고 현장약도</h1>

  <div id="map">

    <!-- ① 카카오 지도 캡처 -->
    <img id="bgMap" src="kakao_capture.jpg" alt="kakao map">

    <!-- ② 자유곡선 캔버스 -->
    <canvas id="drawCanvas"></canvas>

    <!-- ③ 속성 패널 -->
    <div id="panel">
      <strong>선택 객체</strong>
      <label>각도
        <input id="angle" type="range" min="-180" max="180" value="0">
      </label>
      <label>크기
        <input id="size" type="range" min="10" max="150" value="32">
      </label>
      <label>글자크기
        <input id="fontSize" type="range" min="8" max="48" value="14">
      </label>
      <label>폭
        <input id="width" type="range" min="10" max="300" value="60">
      </label>
    </div>

    <!-- 도구 -->
    <div id="toolbox">
      <button id="toolToggle">☰</button>
      <div id="toolContent">
        <button onclick="addIcon('person')">사람</button>
        <button onclick="addIcon('car')">자동차</button>
        <button onclick="addIcon('bike')">자전거</button>
        <button onclick="addIcon('moto')">오토바이</button>
        <button onclick="addArrow()">화살표</button>
        <button onclick="addText()">문자</button>

        <hr>

        <button onclick="drawMode=!drawMode">자유곡선</button>
        <button onclick="togglePointLine()">직선(점→점)</button>
        <label>선색 <input type="color" id="lineColor" value="#ff0000"></label>
        <label>굵기 <input type="range" id="lineWidth" min="1" max="15" value="3"></label>
        <button onclick="savePDF()">PDF</button>

        <hr>

        <!-- ① PC/스마트폰에서 이미지 선택 -->
        <label style="font-size:12px; display:block; margin-top:6px;">
          배경 이미지 불러오기
          <input type="file" id="bgInput" accept="image/*">
        </label>
      </div>

    </div>

  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
const mapDiv = document.getElementById('map');
const canvas = document.getElementById('drawCanvas');
const ctx = canvas.getContext('2d');
const panel = document.getElementById('panel');

function resizeCanvas(){
  canvas.width = mapDiv.clientWidth;
  canvas.height = mapDiv.clientHeight;
}
resizeCanvas();
window.addEventListener('resize', resizeCanvas);

/* ===== 공통 ===== */
const icons={
  person:'icons/person.png',
  car:'icons/car.png',
  bike:'icons/bike.png',
  moto:'icons/moto.png',
  arrow:'icons/arrow.png'
};

let selected=null;
function centerPos(){
  const r=mapDiv.getBoundingClientRect();
  return {x:r.width/2-16, y:r.height/2-16};
}

function select(el){
  selected=el;
  panel.style.visibility='visible';
  panel.style.opacity='1';
}

/* ===== 드래그 ===== */
function drag(el){
  let sx, sy, ox, oy, dragging = false;

  el.style.touchAction = 'none';

  el.addEventListener('pointerdown', e=>{
    select(el);

    // ✋ 텍스트 + 편집 중이면 드래그 금지
    if(el.classList.contains('textbox') && el.isEditing){
      return;
    }

    sx = e.clientX;
    sy = e.clientY;
    ox = parseFloat(el.style.left) || 0;
    oy = parseFloat(el.style.top) || 0;
    dragging = true;

    document.body.style.overflow = 'hidden';
    el.setPointerCapture(e.pointerId);
    e.preventDefault();
  });

  el.addEventListener('pointermove', e=>{
    if(!dragging) return;
    el.style.left = (ox + e.clientX - sx) + 'px';
    el.style.top  = (oy + e.clientY - sy) + 'px';
  });

  el.addEventListener('pointerup', ()=>{
    dragging = false;
    document.body.style.overflow = '';
  });

  el.addEventListener('pointercancel', ()=>{
    dragging = false;
    document.body.style.overflow = '';
  });
}




/* ===== 객체 ===== */
function addIcon(type){
  const p=centerPos();
  const img=document.createElement('img');
  img.src=icons[type];
  img.className='icon';
  img.style.left=p.x+'px';
  img.style.top=p.y+'px';
  img.style.width='32px';
  mapDiv.appendChild(img);
  drag(img);
}

function addArrow(){
  const p=centerPos();
  const img=document.createElement('img');
  img.src=icons.arrow;
  img.className='arrow';
  img.style.left=p.x+'px';
  img.style.top=p.y+'px';
  img.style.width='32px';
  mapDiv.appendChild(img);
  drag(img);
}

function addText(){
  const p=centerPos();
  const t=document.createElement('input');
  t.className='textbox';
  t.placeholder='텍스트';
  t.style.left=p.x+'px';
  t.style.top=p.y+'px';
  t.style.fontSize='14px';
  t.style.height='auto';
  t.style.minHeight='20px';
  t.style.padding='0 4px';
  t.style.textAlign='center';
  t.style.width='14px';
  mapDiv.appendChild(t);

  drag(t); enableDelete(t);

  const adjustSize=()=>{
    const fs=parseFloat(window.getComputedStyle(t).fontSize)||14;
    const text=t.value||t.placeholder||'한';
    const canvas=document.createElement('canvas');
    const ctx=canvas.getContext('2d');
    ctx.font=`${fs}px sans-serif`;
    const textWidth=ctx.measureText(text).width;
    t.style.width=(textWidth+8)+'px';
    t.style.height=(fs+4)+'px';
  };

  t.addEventListener('input', adjustSize);
  t.addEventListener('change', adjustSize);
  t.addEventListener('pointerdown', adjustSize);

  const fontInput=document.getElementById('fontSize');
  fontInput.addEventListener('input', ()=>{
    if(selected===t){ t.style.fontSize=fontInput.value+'px'; adjustSize();}
  });

  adjustSize();
}



/* ===== 선 ===== */
let drawMode=false;
let drawing=false;
let firstPoint=null;
let currentLineWidth=3;
let currentLineColor='#ff0000';

canvas.addEventListener('pointerdown', e=>{
  if(!drawMode) return;
  drawing=true;
  ctx.beginPath();
  ctx.moveTo(e.offsetX,e.offsetY);
});
canvas.addEventListener('pointermove', e=>{
  if(!drawing) return;
  ctx.lineTo(e.offsetX,e.offsetY);
  ctx.strokeStyle=currentLineColor;
  ctx.lineWidth=currentLineWidth;
  ctx.stroke();
});
canvas.addEventListener('pointerup', ()=>drawing=false);

function togglePointLine(){
  firstPoint=null;
  drawMode=false;
  canvas.onclick=e=>{
    if(!firstPoint){
      firstPoint={x:e.offsetX,y:e.offsetY};
    }else{
      ctx.beginPath();
      ctx.moveTo(firstPoint.x,firstPoint.y);
      ctx.lineTo(e.offsetX,e.offsetY);
      ctx.strokeStyle=currentLineColor;
      ctx.lineWidth=currentLineWidth;
      ctx.stroke();
      firstPoint=null;
    }
  };
}

document.getElementById('lineWidth').oninput=e=>currentLineWidth=e.target.value;
document.getElementById('lineColor').oninput=e=>currentLineColor=e.target.value;

/* ===== PDF ===== */
async function savePDF(){
  const canvasImg=await html2canvas(container);
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF('p','mm','a4');
  const w=pdf.internal.pageSize.getWidth();
  const h=canvasImg.height*w/canvasImg.width;
  pdf.addImage(canvasImg.toDataURL(),'PNG',0,0,w,h);
  pdf.save('Traffic_Accident_Scene_Diagram.pdf');
}

/* ===== 도구 토글 ===== */
toolToggle.onclick=()=>{
  toolContent.style.display=
    toolContent.style.display==='block'?'none':'block';
};

/* ===== 배경 이미지 선택 ===== */
const bgMap = document.getElementById('bgMap');
const bgInput = document.getElementById('bgInput');

// 배경 이미지 선택 코드 끝
bgInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(evt){
    bgMap.src = evt.target.result;  // 선택한 이미지로 변경
  }
  reader.readAsDataURL(file);
});

/* ===== 선택 객체 속성 패널 슬라이더 이벤트 연결 ===== */
const angleInput = document.getElementById('angle');
const sizeInput = document.getElementById('size');
const fontSizeInput = document.getElementById('fontSize');
const widthInput = document.getElementById('width');

angleInput.addEventListener('input', ()=> {
  if(!selected) return;
  selected.style.transform = `rotate(${angleInput.value}deg)`; 
});

sizeInput.addEventListener('input', ()=> {
  if(!selected) return;
  selected.style.width = sizeInput.value + 'px';
  if(selected.tagName === 'IMG') selected.style.height = 'auto';
});

fontSizeInput.addEventListener('input', ()=> {
  if(!selected) return;
  if(selected.tagName === 'INPUT') selected.style.fontSize = fontSizeInput.value + 'px';
});

widthInput.addEventListener('input', ()=> {
  if(!selected) return;
  if(selected.tagName === 'INPUT') {
    selected.style.width = widthInput.value + 'px';
  } else if(selected.classList.contains('arrow')) {
    selected.style.width = widthInput.value + 'px';
    selected.style.height = 'auto';
  }
});


</script>

</body>
</html>
