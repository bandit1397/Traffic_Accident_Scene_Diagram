<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Traffic Accident Scene Diagram</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; background:#eee; font-family:sans-serif; }

#container {
  width:210mm;
  min-height:297mm;
  margin:20px auto;
  padding:10mm;
  background:#fff;
  border:1px solid #ccc;
}

h1 { text-align:center; }

#map {
  width:100%;
  height:600px;
  border:1px solid #888;
  position:relative;
}

#controls {
  display:flex;
  justify-content:center;
  gap:6px;
  margin-top:8px;
  overflow-x: auto;  /* â† ì¶”ê°€ */
  padding: 2px 0;    /* â† ì¶”ê°€ */
}

#controls::-webkit-scrollbar {
  height: 4px;       /* ìŠ¤í¬ë¡¤ë°” ë†’ì´ */
}
#controls::-webkit-scrollbar-thumb {
  background: #888;  /* ìŠ¤í¬ë¡¤ë°” ìƒ‰ìƒ */
  border-radius: 2px;
}


button { padding:5px 10px; }

.icon, .arrow {
  position:absolute;
  cursor:move;
  z-index:1000;
}

.arrow { transform-origin:center; }

.textbox {
  position:absolute;
  border:1px solid #333;
  background:#fff;
  padding:2px;
  resize:both;
  overflow:auto;
  cursor:move;
  z-index:1000;
}

/* ì†ì„± íŒ¨ë„ */
#panel {
  position:fixed;
  right:10px;
  bottom:10px;
  background:#fff;
  border:1px solid #333;
  padding:10px;
  width:200px;
  display:none;
  z-index:2000;
}

#panel label {
  font-size:12px;
  display:block;
  margin-top:6px;
}

/* =========================
   ëª¨ë°”ì¼ ëŒ€ì‘ ìŠ¤íƒ€ì¼
========================= */
@media(max-width:768px){
  #controls {
    flex-wrap: wrap;
    justify-content: center;
    gap: 4px;
    margin-top: 6px;
  }

  #controls button {
    flex: 1 1 30%;
    min-width: 80px;
    min-height: 40px;
    padding: 10px 5px;
    font-size: 14px;
  }

  /* âœ… ëª¨ë°”ì¼ íŒ¨ë„: JSê°€ ìœ„ì¹˜ë¥¼ ì œì–´ */
  #panel {
    position: fixed;      /* â˜… í•„ìˆ˜ */
    width: 200px;         /* ê°ì²´ ì˜†ì— ëœ¨ê²Œ */
    display: none;
    padding: 10px;
    border-radius: 6px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.25);
  }

  #panel label {
    font-size: 14px;
  }
}



</style>
</head>

<body>

<div id="container">
<h1>êµí†µì‚¬ê³  í˜„ì¥ì•½ë„</h1>

<div id="map"></div>

<div id="controls">
  <button onclick="addIcon('person')">ì‚¬ëŒ</button>
  <button onclick="addIcon('car')">ìë™ì°¨</button>
  <button onclick="addIcon('bike')">ìì „ê±°</button>
  <button onclick="addIcon('moto')">ì˜¤í† ë°”ì´</button>
  <button onclick="addArrow()">í™”ì‚´í‘œ</button>
  <button onclick="addText()">ë¬¸ì</button>
  <button onclick="toggleMap()">ì§€ë„ ì ê¸ˆ / í•´ì œ</button>
  <button onclick="savePDF()">PDF</button>
</div>
</div>

<!-- ì†ì„± íŒ¨ë„ -->
<div id="panel">
<strong>ì„ íƒ ê°ì²´</strong>
<label>ê°ë„ <input id="angle" type="number"></label>
<label>í¬ê¸° <input id="size" type="number"></label>
<label>ê¸€ìí¬ê¸° <input id="fontSize" type="number"></label>
<label>í­ <input id="width" type="number"></label>
</div>

<!-- PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* =========================
   ì§€ë„ ìƒì„±
========================= */
const leafletMap = L.map('map', {
  maxZoom: 19,
  zoomSnap: 0.25,
  wheelPxPerZoomLevel: 40
}).setView([37.5665, 126.978], 18);

L.tileLayer(
  'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
  { maxZoom: 19, attribution: 'Â© OpenStreetMap' }
).addTo(leafletMap);

/* =========================
   ì§€ë„ ì ê¸ˆ / í•´ì œ
========================= */
let mapLocked = false;

function lockMap(){
  // ë“œë˜ê·¸
  leafletMap.dragging.disable();
  
  // í„°ì¹˜ ê´€ë ¨
  leafletMap.touchZoom.disable();  // í•€ì¹˜ ì¤Œ ë§‰ê¸°
  leafletMap.doubleClickZoom.disable();
  leafletMap.scrollWheelZoom.disable();
  leafletMap.boxZoom.disable();
  leafletMap.keyboard.disable();
  if (leafletMap.tap) leafletMap.tap.disable();

  mapLocked = true;
}

function unlockMap(){
  leafletMap.dragging.enable();
  leafletMap.touchZoom.enable();   // í•€ì¹˜ ì¤Œ í—ˆìš©
  leafletMap.doubleClickZoom.enable();
  leafletMap.scrollWheelZoom.enable();
  leafletMap.boxZoom.enable();
  leafletMap.keyboard.enable();
  if (leafletMap.tap) leafletMap.tap.enable();

  mapLocked = false;
}


function toggleMap(){
  mapLocked ? unlockMap() : lockMap();
}

/* =========================
   ì•„ì´ì½˜ ê²½ë¡œ
========================= */
const icons = {
  person:'icons/person.png',
  car:'icons/car.png',
  bike:'icons/bike.png',
  moto:'icons/moto.png',
  arrow:'icons/arrow.png'
};

const mapDiv = leafletMap.getContainer();
let selected = null;
const panel = document.getElementById('panel');

/* =========================
   ê³µí†µ
========================= */
function centerPos(){
  const r = mapDiv.getBoundingClientRect();
  return { x:r.width/2-16, y:r.height/2-16 };
}

function select(el){
  selected = el;

  if (window.innerWidth <= 768) {
    const rect = el.getBoundingClientRect();
    const panelWidth = 200;
    const panelHeight = panel.offsetHeight || 180;
    const margin = 8;

    let left = rect.right + margin;
    let top  = rect.top;

    /* ğŸ‘‰ í™”ë©´ ì˜¤ë¥¸ìª½ ì´ˆê³¼ ì‹œ ì™¼ìª½ */
    if (left + panelWidth > window.innerWidth) {
      left = rect.left - panelWidth - margin;
    }

    /* ğŸ‘‰ ìœ„/ì•„ë˜ ì•ˆì „ ë³´ì • */
    if (top < 10) top = 10;
    if (top + panelHeight > window.innerHeight) {
      top = window.innerHeight - panelHeight - 10;
    }

    /* ğŸ”‘ ëª¨ë°”ì¼ CSS í•˜ë‹¨ ê³ ì • ì™„ì „ í•´ì œ */
    panel.style.position = 'fixed';
    panel.style.left = left + 'px';
    panel.style.top = top + 'px';
    panel.style.right = 'auto';
    panel.style.bottom = 'auto';
    panel.style.width = '200px';   // ëª¨ë°”ì¼ ì „ì²´í­ ë¬´íš¨í™”
    panel.style.display = 'block';

  } else {
    /* ğŸ–¥ PCëŠ” ê¸°ì¡´ ê·¸ëŒ€ë¡œ */
    panel.style.display = 'block';
  }
}



function drag(el){
  let startX = 0, startY = 0;
  let origX = 0, origY = 0;
  let dragging = false;
  let holdTimer = null;

  el.style.touchAction = 'none';

  el.addEventListener('pointerdown', e => {

    select(el);
    el.style.zIndex = 3000;

    startX = e.clientX;
    startY = e.clientY;
    origX = parseFloat(el.style.left);
    origY = parseFloat(el.style.top);

    // ğŸ”‘ INPUTì€ ê¸¸ê²Œ ëˆŒëŸ¬ì•¼ ì´ë™
    if (el.tagName === 'INPUT') {
      holdTimer = setTimeout(() => {
        dragging = true;
        el.setPointerCapture(e.pointerId);
      }, 200); // 0.2ì´ˆ
      return;
    }

    // ì•„ì´ì½˜/í™”ì‚´í‘œëŠ” ì¦‰ì‹œ ì´ë™
    e.preventDefault();
    dragging = true;
    el.setPointerCapture(e.pointerId);
  });

  el.addEventListener('pointermove', e => {
    if(!dragging) return;

    const dx = e.clientX - startX;
    const dy = e.clientY - startY;

    el.style.left = (origX + dx) + 'px';
    el.style.top  = (origY + dy) + 'px';
  });

  el.addEventListener('pointerup', () => {
    dragging = false;
    clearTimeout(holdTimer);
  });

  el.addEventListener('pointercancel', () => {
    dragging = false;
    clearTimeout(holdTimer);
  });
}


function enableDelete(el){
  // PC: ìš°í´ë¦­
  el.addEventListener('contextmenu', e => {
    e.preventDefault();
    if (confirm('ì´ ê°ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
      el.remove();
    }
  });
}


/* =========================
   ê°ì²´ ì¶”ê°€
========================= */
function addIcon(type){
  const p=centerPos();
  const img=document.createElement('img');
  img.src=icons[type];
  img.className='icon';
  img.style.left=p.x+'px';
  img.style.top=p.y+'px';
  img.style.width='32px';
  mapDiv.appendChild(img);
  drag(img);
  enableDelete(img);   // âœ… ì¶”ê°€
}


function addArrow(){
  const p=centerPos();
  const a=document.createElement('img');
  a.src=icons.arrow;
  a.className='arrow';
  a.style.left=p.x+'px';
  a.style.top=p.y+'px';
  a.style.width='32px';
  mapDiv.appendChild(a);
  drag(a);
  enableDelete(a);     // âœ… ì¶”ê°€
}


function addText(){
  const p = centerPos();
  const t = document.createElement('input');
  t.className = 'textbox';
  t.placeholder = 'í…ìŠ¤íŠ¸';
  t.style.left = p.x + 'px';
  t.style.top  = p.y + 'px';
  t.style.fontSize = '14px';
  t.style.height = 'auto';
  t.style.minHeight = '20px';
  t.style.padding = '0 4px';
  t.style.textAlign = 'center';
  t.style.width = '14px'; // ì´ˆê¸° í­
  mapDiv.appendChild(t);

  drag(t);
  enableDelete(t);

  // -----------------------------
  // í­ ê³„ì‚° í•¨ìˆ˜
  // -----------------------------
  const adjustSize = () => {
    const fs = parseFloat(window.getComputedStyle(t).fontSize) || 14;
    const text = t.value || t.placeholder || 'í•œ';
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    ctx.font = `${fs}px sans-serif`;
    const textWidth = ctx.measureText(text).width;
    t.style.width = (textWidth + 8) + 'px'; // ì¢Œìš° 4px ì—¬ë°± í¬í•¨
    t.style.height = (fs + 4) + 'px'; // ë†’ì´: ê¸€ì í¬ê¸° + 4px
  };

  // -----------------------------
  // ì´ë²¤íŠ¸
  // -----------------------------
  t.addEventListener('input', adjustSize);
  t.addEventListener('change', adjustSize);

  // fontSize íŒ¨ë„ ì…ë ¥ì—ì„œ ì¦‰ì‹œ ì ìš©
  const fontInput = document.getElementById('fontSize');
  fontInput.addEventListener('input', () => {
    if(selected === t){
      t.style.fontSize = fontInput.value + 'px';
      adjustSize(); // ë°”ë¡œ í­ ì¡°ì ˆ
    }
  });

  // í´ë¦­/í„°ì¹˜ ì‹œì—ë„ í­ ì¬ì¡°ì •
  t.addEventListener('pointerdown', adjustSize);

  adjustSize(); // ì´ˆê¸° ì ìš©
}




// =========================
// âœ… ì—¬ê¸°ì— ì¶”ê°€
// ì†ì„± íŒ¨ë„ ì…ë ¥ ì ìš©
// =========================

// ê°ë„ ì…ë ¥
document.getElementById('angle').addEventListener('input', e => {
  if (!selected) return;
  const deg = parseFloat(e.target.value) || 0;
  selected.style.transform = `rotate(${deg}deg)`;
});

// í¬ê¸° ì…ë ¥ (ì•„ì´ì½˜/í™”ì‚´í‘œ)
document.getElementById('size').addEventListener('input', e => {
  if (!selected) return;
  const s = parseFloat(e.target.value) || 32;
  if (selected.tagName === 'IMG') {
    selected.style.width = s + 'px';
    selected.style.height = 'auto';
  }
});

// ê¸€ìí¬ê¸° (ë¬¸ì ë°•ìŠ¤)
document.getElementById('fontSize').addEventListener('input', e => {
  if (!selected) return;
  const fs = parseFloat(e.target.value) || 12;
  if (selected.tagName === 'INPUT') {
    selected.style.fontSize = fs + 'px';
  }
});

// í­ (ë¬¸ì ë°•ìŠ¤)
document.getElementById('width').addEventListener('input', e => {
  if (!selected) return;
  const w = parseFloat(e.target.value) || 100;
  if (selected.tagName === 'INPUT') {
    selected.style.width = w + 'px';
  }
});



/* =========================
   PDF ì €ì¥
========================= */
async function savePDF(){
  lockMap();
  const canvas = await html2canvas(container,{useCORS:true});
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF('p','mm','a4');
  const w = pdf.internal.pageSize.getWidth();
  const h = canvas.height * w / canvas.width;
  pdf.addImage(canvas.toDataURL(),'PNG',0,0,w,h);
  pdf.save('Traffic_Accident_Scene_Diagram.pdf');
  unlockMap();
}
</script>

</body>
</html>
