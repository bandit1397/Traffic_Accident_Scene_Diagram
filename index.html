<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Traffic Accident Scene Diagram</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; background:#eee; font-family:sans-serif; }

#container {
  position: relative;
  width:210mm;
  min-height:297mm;
  margin:20px auto;
  padding:10mm;
  background:#fff;
  border:1px solid #ccc;
}

h1 { text-align:center; }

#map {
  width:100%;
  height:600px;
  border:1px solid #888;
  position:relative;
}

/* ===== ê°ì²´ ===== */
.icon, .arrow {
  position:absolute;
  cursor:move;
  z-index:1000;
}
.arrow { transform-origin:center; }

.textbox {
  position:absolute;
  border:1px solid #333;
  background:#fff;
  padding:2px;
  resize:both;
  cursor:move;
  z-index:1000;
}

/* ===== ì†ì„± íŒ¨ë„ ===== */
#panel {
  position: absolute;
  left: 10px;
  top: 50%;
  transform: translateY(-50%);
  background: #fff;
  border: 1px solid #333;
  padding: 10px;
  width: 200px;
  visibility: hidden;
  opacity: 0;
  z-index: 3000;
}

#panel label {
  font-size:12px;
  display:block;
  margin-top:6px;
}

#panel input[type="range"]{
  width:100%;
}

/* ===== ì¢Œì¸¡ ê³ ì • ë„êµ¬ íŒ¨ë„ ===== */
#toolbox {
  position: static;      /* Leafletì´ ìœ„ì¹˜ ê´€ë¦¬ */
  width: auto;
}

/* Leaflet ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
.leaflet-control.toolbox {
  background: transparent;
}

#toolToggle {
  width: 44px;
  height: 44px;
  font-size: 22px;
  border-radius: 8px;
  background: #333;
  color: #fff;
  border: none;
}

#toolContent {
  display: none;
  margin-top: 6px;
  background: #fff;
  border: 1px solid #333;
  border-radius: 10px;
  padding: 6px;

  width: 120px;        /* â­ í•µì‹¬ */
  max-width: 70vw;     /* ëª¨ë°”ì¼ ì•ˆì „ */
}

#toolContent button {
  width: 100%;
  min-height: 32px;
  margin: 2px 0;
  font-size: 13px;
}
  
#toolContent label {
  font-size: 12px;
  display: block;
  margin-top: 4px;
}

#toolContent hr {
  margin: 6px 0;
}

/* ===== ëª¨ë°”ì¼ ===== */
@media (max-width: 768px){
  #toolContent {
    width: 105px;
  }
}
  
</style>
</head>

<body>

<div id="container">
  <h1>êµí†µì‚¬ê³  í˜„ì¥ì•½ë„</h1>

  <div id="map">
    <!-- ì†ì„± íŒ¨ë„ (ì§€ë„ ë‚´ë¶€ í¬í•¨) -->
    <div id="panel">
      <strong>ì„ íƒ ê°ì²´</strong>
      <label>ê°ë„
        <input id="angle" type="range" min="-180" max="180" step="1" value="0">
      </label>
      <label>í¬ê¸°
        <input id="size" type="range" min="10" max="150" step="1" value="32">
      </label>
      <label>ê¸€ìí¬ê¸°
        <input id="fontSize" type="range" min="8" max="48" step="1" value="14">
      </label>
      <label>í­
        <input id="width" type="range" min="10" max="300" step="2" value="60">
      </label>
    </div>
  </div>

  <!-- ===== ì¢Œì¸¡ ë„êµ¬ íŒ¨ë„ ===== -->
<div id="toolbox">
  <button id="toolToggle">â˜°</button>

  <div id="toolContent">
    <button onclick="addIcon('person')">ì‚¬ëŒ</button>
    <button onclick="addIcon('car')">ìë™ì°¨</button>
    <button onclick="addIcon('bike')">ìì „ê±°</button>
    <button onclick="addIcon('moto')">ì˜¤í† ë°”ì´</button>
    <button onclick="addArrow()">í™”ì‚´í‘œ</button>
    <button onclick="addText()">ë¬¸ì</button>

    <hr>

    <button onclick="toggleMap()">ì§€ë„ ì ê¸ˆ/í•´ì œ</button>
    <button onclick="drawMode = !drawMode; mapLocked = drawMode;">ììœ ê³¡ì„ </button>
    <button onclick="togglePointLine()">ì§ì„ (ì â†’ì )</button>

    <label>
      ì„ ìƒ‰
      <input type="color" id="lineColor" value="#ff0000">
    </label>

    <label>
      êµµê¸°
      <input type="range" id="lineWidth" min="1" max="15" value="3">
    </label>

    <button onclick="savePDF()">PDF</button>
  </div>
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ===== ì§€ë„ ===== */
const leafletMap = L.map('map',{
  maxZoom:19,
  zoomSnap:0.25,
  wheelPxPerZoomLevel:40
}).setView([37.5665,126.978],18);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19,
  attribution:'Â© OpenStreetMap'
}).addTo(leafletMap);

/* ===== ì¢Œì¸¡ ìƒë‹¨ ë„êµ¬ íŒ¨ë„ì„ Leaflet ì»¨íŠ¸ë¡¤ë¡œ ê³ ì • ===== */
const ToolControl = L.Control.extend({
  options: {
    position: 'topleft'   // ì¤Œ +/- ìœ„ì¹˜
  },

  onAdd: function () {
    const div = document.getElementById('toolbox');

    L.DomEvent.disableClickPropagation(div);
    L.DomEvent.disableScrollPropagation(div);

    div.classList.add('toolbox'); // â† ì´ ì¤„ ì¤‘ìš”

    return div;
  }
});

leafletMap.addControl(new ToolControl());


/* ===== ì§€ë„ ì ê¸ˆ/í•´ì œ ===== */
let mapLocked=false;
function lockMap(){
  leafletMap.dragging.disable();
  leafletMap.touchZoom.disable();
  leafletMap.doubleClickZoom.disable();
  leafletMap.scrollWheelZoom.disable();
  leafletMap.boxZoom.disable();
  leafletMap.keyboard.disable();
  if(leafletMap.tap) leafletMap.tap.disable();
  mapLocked=true;
}
function unlockMap(){
  leafletMap.dragging.enable();
  leafletMap.touchZoom.enable();
  leafletMap.doubleClickZoom.enable();
  leafletMap.scrollWheelZoom.enable();
  leafletMap.boxZoom.enable();
  leafletMap.keyboard.enable();
  if(leafletMap.tap) leafletMap.tap.enable();
  mapLocked=false;
}
function toggleMap(){ mapLocked ? unlockMap() : lockMap(); }

/* ===== ì â†’ì  ì§ì„  ëª¨ë“œ í† ê¸€ ===== */
function togglePointLine(){
  linePointMode = !linePointMode;
  drawMode = false;        // ììœ ê³¡ì„  ë¹„í™œì„±í™”
  mapLocked = linePointMode;
  firstPoint = null;

  alert(linePointMode ? 'ì§ì„  ëª¨ë“œ ON (ë‘ ì ì„ í´ë¦­)' : 'ì§ì„  ëª¨ë“œ OFF');
}


/* ===== ê³µí†µ ===== */
const icons={
  person:'icons/person.png',
  car:'icons/car.png',
  bike:'icons/bike.png',
  moto:'icons/moto.png',
  arrow:'icons/arrow.png'
};

const mapDiv = leafletMap.getContainer();
const panel=document.getElementById('panel');
let selected=null;
let panelInitialized=false;

function centerPos(){
  const r=mapDiv.getBoundingClientRect();
  return {x:r.width/2-16, y:r.height/2-16};
}

function select(el){
  if(selected===el) return;
  selected=el;
  panel.style.display='block';
  panel.style.visibility='visible';
  panel.style.opacity='1';

  angle.value = el.style.transform
    ? (el.style.transform.match(/-?\d+/)?.[0]||0)
    : 0;
  if(el.tagName==='IMG') size.value = parseFloat(el.style.width)||32;
  if(el.tagName==='INPUT'){
    fontSize.value = parseFloat(el.style.fontSize)||14;
    width.value    = parseFloat(el.style.width)||60;
  }

  if(panelInitialized) return;
  panelInitialized=true;

  if(window.innerWidth<=768){
    const mapRect = mapDiv.getBoundingClientRect();
    const elRect = el.getBoundingClientRect();
    const pw = panel.offsetWidth;
    const ph = panel.offsetHeight;
    const m = 8;
    let left = elRect.right-mapRect.left+m;
    let top = elRect.top-mapRect.top;
    if(left+pw>mapRect.width) left = elRect.left-mapRect.left-pw-m;
    if(top<0) top=0;
    if(top+ph>mapRect.height) top=mapRect.height-ph;
    panel.style.left=left+'px';
    panel.style.top=top+'px';
    panel.style.right='auto';
    panel.style.bottom='auto';
  } else {
    panel.style.position='absolute';
    panel.style.left='10px';
    panel.style.top='50%';
    panel.style.transform='translateY(-50%)';
  }
}

function drag(el){
  let sx,sy,ox,oy,dragging=false;
  el.style.touchAction='none';

  el.addEventListener('pointerdown', e=>{
    select(el);
    const isInput = el.tagName==='INPUT';
    sx=e.clientX; sy=e.clientY;
    ox=parseFloat(el.style.left); oy=parseFloat(el.style.top);
    dragging=true;
    el.setPointerCapture(e.pointerId);
    if(!isInput) e.preventDefault();
  });

  el.addEventListener('pointermove', e=>{
    if(!dragging) return;
    el.style.left=(ox+e.clientX-sx)+'px';
    el.style.top =(oy+e.clientY-sy)+'px';
  });

  el.addEventListener('pointerup', ()=>dragging=false);
}

function enableDelete(el){
  el.addEventListener('contextmenu', e=>{
    e.preventDefault();
    if(confirm('ì´ ê°ì²´ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) el.remove();
  });
}

/* ===== ê°ì²´ ì¶”ê°€ ===== */
function addIcon(type){
  const p=centerPos();
  const img=document.createElement('img');
  img.src=icons[type];
  img.className='icon';
  img.style.left=p.x+'px';
  img.style.top=p.y+'px';
  img.style.width='32px';
  mapDiv.appendChild(img);
  drag(img); enableDelete(img);
}

function addArrow(){
  const p=centerPos();
  const a=document.createElement('img');
  a.src=icons.arrow;
  a.className='arrow';
  a.style.left=p.x+'px';
  a.style.top=p.y+'px';
  a.style.width='32px';
  mapDiv.appendChild(a);
  drag(a); enableDelete(a);
}

function addText(){
  const p=centerPos();
  const t=document.createElement('input');
  t.className='textbox';
  t.placeholder='í…ìŠ¤íŠ¸';
  t.style.left=p.x+'px';
  t.style.top=p.y+'px';
  t.style.fontSize='14px';
  t.style.height='auto';
  t.style.minHeight='20px';
  t.style.padding='0 4px';
  t.style.textAlign='center';
  t.style.width='14px';
  mapDiv.appendChild(t);

  drag(t); enableDelete(t);

  const adjustSize=()=>{
    const fs=parseFloat(window.getComputedStyle(t).fontSize)||14;
    const text=t.value||t.placeholder||'í•œ';
    const canvas=document.createElement('canvas');
    const ctx=canvas.getContext('2d');
    ctx.font=`${fs}px sans-serif`;
    const textWidth=ctx.measureText(text).width;
    t.style.width=(textWidth+8)+'px';
    t.style.height=(fs+4)+'px';
  };

  t.addEventListener('input', adjustSize);
  t.addEventListener('change', adjustSize);
  t.addEventListener('pointerdown', adjustSize);

  const fontInput=document.getElementById('fontSize');
  fontInput.addEventListener('input', ()=>{
    if(selected===t){ t.style.fontSize=fontInput.value+'px'; adjustSize();}
  });

  adjustSize();
}

/* ===== íŒ¨ë„ ì…ë ¥ ===== */
angle.oninput=e=>{ if(selected) selected.style.transform=`rotate(${e.target.value}deg)`; };
size.oninput=e=>{ if(selected&&selected.tagName==='IMG') selected.style.width=e.target.value+'px'; };
fontSize.oninput=e=>{ if(selected&&selected.tagName==='INPUT') selected.style.fontSize=e.target.value+'px'; };
width.oninput=e=>{ if(selected&&selected.tagName==='INPUT') selected.style.width=e.target.value+'px'; };

/* ===== ììœ ê³¡ì„  ê·¸ë¦¬ê¸° ì½”ë“œ ===== */
let currentLineWidth = 3;          // ì„  êµµê¸°
let currentLineColor = '#ff0000';  // ì„  ìƒ‰ìƒ

let drawMode = false;              // ììœ ê³¡ì„  ëª¨ë“œ ON/OFF
let drawing = false;               // í˜„ì¬ ê·¸ë¦¬ê³  ìˆëŠ” ì¤‘ì¸ì§€
let currentLine = null;            // í˜„ì¬ ê·¸ë¦¬ëŠ” ì„ 
let freeLines = [];                // ê·¸ë ¤ì§„ ëª¨ë“  ììœ ê³¡ì„ 

/* ===== ì  â†’ ì  ì§ì„  ëª¨ë“œ ===== */
let linePointMode = false;     // ì â†’ì  ì§ì„  ëª¨ë“œ
let firstPoint = null;         // ì²« ë²ˆì§¸ í´ë¦­ ì¢Œí‘œ
let pointLines = [];           // ìƒì„±ëœ ì§ì„ ë“¤

/* ===== ììœ ê³¡ì„  UI ì—°ê²° ===== */
document.getElementById('lineWidth').addEventListener('input', e => {
  currentLineWidth = Number(e.target.value);
});

document.getElementById('lineColor').addEventListener('input', e => {
  currentLineColor = e.target.value;
});

/* ===== ììœ ê³¡ì„  ê·¸ë¦¬ê¸° ì½”ë“œ ===== */
mapDiv.addEventListener('pointerdown', e => {
  if (!drawMode) return;
  drawing = true;
  const point = leafletMap.mouseEventToLatLng(e);
  currentLine = L.polyline(
    [point],
    {
      color: currentLineColor,
      weight: currentLineWidth,
      lineCap: 'round',
      lineJoin: 'round'
    }
  ).addTo(leafletMap);
});

mapDiv.addEventListener('pointermove', e => {
  if (!drawing || !currentLine) return;
  currentLine.addLatLng(leafletMap.mouseEventToLatLng(e));
});

mapDiv.addEventListener('pointerup', () => {
  if (drawing && currentLine) freeLines.push(currentLine);
  drawing = false;
  currentLine = null;
});

/* ===== ì  â†’ ì  ì§ì„  ìƒì„± ===== */
leafletMap.on('click', e => {
  if (!linePointMode) return;

  if (!firstPoint) {
    firstPoint = e.latlng;
    return;
  }

  const secondPoint = e.latlng;

  const line = L.polyline(
    [firstPoint, secondPoint],
    {
      color: currentLineColor,
      weight: currentLineWidth
    }
  ).addTo(leafletMap);

  // ğŸ”¥ ì§ì„  í´ë¦­ ì‹œ ì‚­ì œ
  line.on('click', ev => {
    L.DomEvent.stopPropagation(ev); // ì§€ë„ í´ë¦­ ë°©ì§€
    deletePointLine(line);
  });

  pointLines.push(line);
  firstPoint = null;
});

/* ===== ììœ ê³¡ì„  ì‚­ì œ ê¸°ëŠ¥ ===== */
mapDiv.addEventListener('click', e => {
  if(drawMode) return;   // ğŸ”‘ ê·¸ë¦¬ëŠ” ì¤‘ì—” ì‚­ì œ ê¸ˆì§€

  const latlng = leafletMap.mouseEventToLatLng(e);

  for(let i = 0; i < freeLines.length; i++){
    const line = freeLines[i];
    const latlngs = line.getLatLngs();

    for(const pt of latlngs){
      const d = leafletMap
        .latLngToContainerPoint(pt)
        .distanceTo(leafletMap.latLngToContainerPoint(latlng));

      if(d < 6){   // í—ˆìš© ì˜¤ì°¨(px)
        leafletMap.removeLayer(line);
        freeLines.splice(i, 1);
        return;
      }
    }
  }
});

/* ===== PDF ===== */
async function savePDF(){
  lockMap();
  const canvas=await html2canvas(container,{useCORS:true});
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF('p','mm','a4');
  const w=pdf.internal.pageSize.getWidth();
  const h=canvas.height*w/canvas.width;
  pdf.addImage(canvas.toDataURL(),'PNG',0,0,w,h);
  pdf.save('Traffic_Accident_Scene_Diagram.pdf');
  unlockMap();
}

/* 3ï¸âƒ£ â˜° ë„êµ¬ í† ê¸€ ì½”ë“œ */
const toggleBtn = document.getElementById('toolToggle');
const toolContent = document.getElementById('toolContent');
toggleBtn.addEventListener('click', () => {
  toolContent.style.display =
    toolContent.style.display === 'block' ? 'none' : 'block';
});


/* ===== ì†ì„± íŒ¨ë„ ë“œë˜ê·¸ ===== */
(function(){
  const panel=document.getElementById('panel');
  let sx=0, sy=0, ox=0, oy=0, dragging=false;
  panel.style.touchAction='none';
  panel.addEventListener('pointerdown', e=>{
    if(e.target.tagName==='INPUT') return;
    dragging=true;
    sx=e.clientX; sy=e.clientY;
    const mapRect=mapDiv.getBoundingClientRect();
    const panelRect=panel.getBoundingClientRect();
    panel.style.transform='none';
    panel.style.left=(panelRect.left-mapRect.left)+'px';
    panel.style.top=(panelRect.top-mapRect.top)+'px';
    ox=parseFloat(panel.style.left); oy=parseFloat(panel.style.top);
    panel.setPointerCapture(e.pointerId);
    e.preventDefault();
  });
  panel.addEventListener('pointermove', e=>{
    if(!dragging) return;
    panel.style.left=(ox+e.clientX-sx)+'px';
    panel.style.top=(oy+e.clientY-sy)+'px';
  });
  panel.addEventListener('pointerup', ()=>dragging=false);
  panel.addEventListener('pointercancel', ()=>dragging=false);
})();
</script>
</body>
</html>
