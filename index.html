<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>Traffic Accident Scene Diagram</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css">
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
body { margin:0; background:#eee; font-family:sans-serif; }

#container {
  width:210mm;
  min-height:297mm;
  margin:20px auto;
  padding:10mm;
  background:#fff;
  border:1px solid #ccc;
}

h1 { text-align:center; }

#map {
  width:100%;
  height:600px;
  border:1px solid #888;
  position:relative;
}

#controls {
  display:flex;
  justify-content:center;
  gap:6px;
  margin-top:8px;
  overflow-x:auto;
}

button { padding:6px 10px; }

/* ê°ì²´ */
.icon,.arrow {
  position:absolute;
  cursor:move;
  z-index:1000;
}
.arrow { transform-origin:center; }

.textbox {
  position:absolute;
  border:1px solid #333;
  background:#fff;
  padding:2px 4px;
  cursor:move;
  z-index:1000;
}

/* ğŸ”’ UI Overlay */
#uiOverlay {
  position:fixed;
  top:10px;
  left:10px;
  z-index:5000;
  pointer-events:none;
}
#uiOverlay button,
#uiOverlay #panel { pointer-events:auto; }

#panelToggle {
  background:#333;
  color:#fff;
  border:none;
  border-radius:4px;
  padding:8px 10px;
}

#panel {
  position:fixed;
  right:10px;
  bottom:10px;
  background:#fff;
  border:1px solid #333;
  padding:10px;
  width:200px;
  display:none;
}

#panel label {
  display:block;
  margin-top:6px;
  font-size:12px;
}

/* ëª¨ë°”ì¼ */
@media(max-width:768px){
  #panel {
    left:0; right:0; bottom:0;
    width:100%;
    border-radius:0;
    box-shadow:0 -2px 6px rgba(0,0,0,.2);
  }
}
</style>
</head>

<body>

<div id="uiOverlay">
  <button id="panelToggle" onclick="togglePanel()">âš™ï¸ ì„¤ì •</button>
  <div id="panel">
    <strong>ì„ íƒ ê°ì²´</strong>
    <label>ê°ë„ <input id="angle" type="number"></label>
    <label>í¬ê¸° <input id="size" type="number"></label>
    <label>ê¸€ìí¬ê¸° <input id="fontSize" type="number"></label>
    <label>í­ <input id="width" type="number"></label>
  </div>
</div>

<div id="container">
<h1>êµí†µì‚¬ê³  í˜„ì¥ì•½ë„</h1>
<div id="map"></div>

<div id="controls">
  <button onclick="addIcon('person')">ì‚¬ëŒ</button>
  <button onclick="addIcon('car')">ìë™ì°¨</button>
  <button onclick="addIcon('bike')">ìì „ê±°</button>
  <button onclick="addIcon('moto')">ì˜¤í† ë°”ì´</button>
  <button onclick="addArrow()">í™”ì‚´í‘œ</button>
  <button onclick="addText()">ë¬¸ì</button>
  <button onclick="lockCurrentView()">ğŸ“Œ í™”ë©´ ê³ ì •</button>
  <button onclick="unlockMap()">ğŸ”“ ì§€ë„ ì¡°ì •</button>
  <button onclick="savePDF()">PDF</button>
</div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
/* ì§€ë„ */
const leafletMap = L.map('map',{zoomSnap:0.25}).setView([37.5665,126.978],18);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom:19
}).addTo(leafletMap);

const mapDiv = leafletMap.getContainer();
const container = document.getElementById('container');

/* ğŸ”’ í™”ë©´ ê³ ì • ìƒíƒœ */
let mapLocked=false;
let lockedView=null;

/* ì§€ë„ ì ê¸ˆ */
function lockMap(){
  leafletMap.dragging.disable();
  leafletMap.touchZoom.disable();
  leafletMap.doubleClickZoom.disable();
  leafletMap.scrollWheelZoom.disable();
  leafletMap.boxZoom.disable();
  leafletMap.keyboard.disable();
  if(leafletMap.tap) leafletMap.tap.disable();
  mapLocked=true;
}

/* ì§€ë„ í•´ì œ */
function unlockMap(){
  leafletMap.dragging.enable();
  leafletMap.touchZoom.enable();
  leafletMap.doubleClickZoom.enable();
  leafletMap.scrollWheelZoom.enable();
  leafletMap.boxZoom.enable();
  leafletMap.keyboard.enable();
  if(leafletMap.tap) leafletMap.tap.enable();
  mapLocked=false;
  lockedView=null;
}

/* âœ… í˜„ì¬ í™”ë©´ ìƒíƒœ ê³ ì • */
function lockCurrentView(){
  lockedView={
    center:leafletMap.getCenter(),
    zoom:leafletMap.getZoom()
  };
  lockMap();
}

/* ğŸ”¥ ê°•ì œ ë³µì› (í•µì‹¬) */
leafletMap.on('move zoom',()=>{
  if(mapLocked && lockedView){
    leafletMap.setView(
      lockedView.center,
      lockedView.zoom,
      {animate:false}
    );
  }
});

/* íŒ¨ë„ */
const panel=document.getElementById('panel');
function togglePanel(){
  panel.style.display = panel.style.display==='block'?'none':'block';
}

/* ê°ì²´ */
const icons={
  person:'icons/person.png',
  car:'icons/car.png',
  bike:'icons/bike.png',
  moto:'icons/moto.png',
  arrow:'icons/arrow.png'
};

let selected=null;

function centerPos(){
  const r=mapDiv.getBoundingClientRect();
  return {x:r.width/2-16,y:r.height/2-16};
}

function select(el){
  if(selected) selected.style.outline='';
  selected=el;
  el.style.outline='2px dashed red';
}

function drag(el){
  let sx,sy,ox,oy,drag=false;
  el.style.touchAction='none';
  el.addEventListener('pointerdown',e=>{
    select(el);
    sx=e.clientX; sy=e.clientY;
    ox=parseFloat(el.style.left);
    oy=parseFloat(el.style.top);
    drag=true;
    el.setPointerCapture(e.pointerId);
  });
  el.addEventListener('pointermove',e=>{
    if(!drag) return;
    el.style.left=(ox+e.clientX-sx)+'px';
    el.style.top =(oy+e.clientY-sy)+'px';
  });
  el.addEventListener('pointerup',()=>drag=false);
}

function enableDelete(el){
  el.addEventListener('contextmenu',e=>{
    e.preventDefault();
    if(confirm('ì‚­ì œí• ê¹Œìš”?')) el.remove();
  });
}

/* ì¶”ê°€ */
function addIcon(type){
  const p=centerPos();
  const img=document.createElement('img');
  img.src=icons[type];
  img.className='icon';
  img.style.left=p.x+'px';
  img.style.top=p.y+'px';
  img.style.width='32px';
  mapDiv.appendChild(img);
  drag(img); enableDelete(img);
}

function addArrow(){
  const p=centerPos();
  const a=document.createElement('img');
  a.src=icons.arrow;
  a.className='arrow';
  a.style.left=p.x+'px';
  a.style.top=p.y+'px';
  a.style.width='32px';
  mapDiv.appendChild(a);
  drag(a); enableDelete(a);
}

function addText(){
  const p=centerPos();
  const t=document.createElement('input');
  t.className='textbox';
  t.placeholder='í…ìŠ¤íŠ¸';
  t.style.left=p.x+'px';
  t.style.top=p.y+'px';
  t.style.fontSize='14px';
  t.style.width='40px';
  mapDiv.appendChild(t);
  drag(t); enableDelete(t);
}

/* íŒ¨ë„ ì—°ë™ */
angle.oninput=e=>{ if(selected) selected.style.transform=`rotate(${e.target.value}deg)`; };
size.oninput=e=>{ if(selected?.tagName==='IMG') selected.style.width=e.target.value+'px'; };
fontSize.oninput=e=>{ if(selected?.tagName==='INPUT') selected.style.fontSize=e.target.value+'px'; };
width.oninput=e=>{ if(selected?.tagName==='INPUT') selected.style.width=e.target.value+'px'; };

/* PDF */
async function savePDF(){
  lockCurrentView();
  const canvas=await html2canvas(container,{useCORS:true});
  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF('p','mm','a4');
  const w=pdf.internal.pageSize.getWidth();
  const h=canvas.height*w/canvas.width;
  pdf.addImage(canvas.toDataURL(),'PNG',0,0,w,h);
  pdf.save('Traffic_Accident_Scene_Diagram.pdf');
}
</script>

</body>
</html>
